@page "/batteryhelper"
@using System.Text.Json
@using MudFPVAssistant.Services
@using Microsoft.AspNetCore.Components.Authorization
@using MudFPVAssistant.Components
@using MudFPVAssistant.Models.DataSources
@inject HttpClient httpClient
@inject IUserDocumentService userFlightService
@inject Blazored.LocalStorage.ILocalStorageService localStorage
@inject IJSRuntime JS
@implements IDisposable
@inject FlightDataFactory factory

<MudContainer MaxWidth="MaxWidth.Medium">
    <MudGrid>
      <!-- Форма додавання нового польоту -->
        <MudItem xs="12" md="6">
            <AddFlightForm OnAdd="AddAsync" />
        </MudItem>

        <!-- Вибір дати та підсвітка днів, коли є польоти -->
        <MudItem xs="12">
            <MudPaper Class="p-4 mb-4">
                <MudText Typo="Typo.h6">Фільтр за датою</MudText>
                <MudDatePicker 
                    Label="Оберіть дату" 
                    @bind-Date="_filterDate"
                    AdditionalDateClassesFunc="GetDayClass" />
            </MudPaper>
        </MudItem>

        <!-- Таблиця історії -->
        <MudItem xs="12">
            <FlightTable Flights="FilteredFlights" OnDelete="DeleteAsync" />
        </MudItem>
        <!-- Статистика та графік -->
        <MudItem xs="12">
            <FlightStats Flights="_ds.Items" />
        </MudItem>

    </MudGrid>
</MudContainer>

@code {
    [CascadingParameter]
    Task<AuthenticationState> AuthStateTask { get; set; }

    private DateTime? _filterDate = DateTime.Today;
    private const string StorageKey = "flight-entries";
    private string _duration;
    private MudDataGrid<FlightInfo> grid;
    private List<FlightInfo> _flights = [];

    private FlightInfo.BatteryType _selectedType = FlightInfo.BatteryType.Unknown;
  
    private IFlightDataSource _ds;

    protected override async Task OnInitializedAsync()
    {

        // Завантажуємо cloud-джерело (сьогодні — єдина реалізація)
        _ds = factory.Get();
        await _ds.InitializeAsync();
        _ds.OnUpdated += Refresh;
    }

    protected override async Task OnParametersSetAsync()
    {
        /*var authState = await AuthStateTask;
        if (authState.User.Identity?.IsAuthenticated == true)
        {
            _flights = await userFlightService.GetAsync<FlightInfo>("FlightInfos");
        }*/
        //_isLoading = false;
    }
    private void Refresh() 
        => InvokeAsync(StateHasChanged);

    private Task AddAsync(FlightInfo flight) 
        => _ds.AddAsync(flight);

    private Task DeleteAsync(string id) 
        => _ds.DeleteAsync(id);

    private IEnumerable<FlightInfo> FilteredFlights =>
        _filterDate == null
            ? _ds.Items
            : _ds.Items.Where(f => f.Date?.Date == _filterDate.Value.Date);

    private string? GetDayClass(DateTime day) 
        => _ds.Items.Any(f => f.Date?.Date == day.Date)
            ? "flight-day"
            : null;

    public void Dispose() 
        => _ds.OnUpdated -= Refresh;

    IDictionary<string, object>? GetDayAttrs(DateTime day)
    {
        var count = _flights.Count(f => f.Date?.Date == day.Date);
        if (count > 0)
            return new Dictionary<string, object>
            {
                ["title"] = $"Польотів: {count}" // браузерний tooltip
            };

        return null; // нічого не додавати
    }
    
    
    private string?[] chartLabels => _flights
        .OrderBy(b => b.Date)
        .Select(b => b.Date.ToString())
        .ToArray();

     
    private async Task SaveToLocalStorage()
    {
        await localStorage.SetItemAsync(StorageKey, _flights);
    }

}

<style>
    .flight-day {
        background: #d28819 !important;
        color: #fff !important;
        border-radius: 50% !important
    }
</style>