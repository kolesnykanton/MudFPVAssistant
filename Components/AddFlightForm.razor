@using MudBlazor
@using MudFPVAssistant.Components

<MudPaper Class="p-4">
    <MudText Typo="Typo.h6">Новий політ</MudText>

    <MudStack Spacing="2">
        <MudTextField Label="Назва батареї" @bind-Value="_draft.Name" />
        <MudNumericField Label="Використано (mAh)" @bind-Value="_draft.UsedMah" />

        <MudSelect T="FlightInfo.BatteryType"
                   Label="Тип батареї"
                   @bind-Value="_draft.BatType"
                   Required="true">
            @foreach (var t in Enum.GetValues<FlightInfo.BatteryType>())
            {
                <MudSelectItem Value="@t">@t</MudSelectItem>
            }
        </MudSelect>

        <MudSelect T="FlightInfo.BatteryCellCount"
                   Label="Кількість ячейок"
                   @bind-Value="_draft.CellCount"
                   Required="true">
            @foreach (var c in Enum.GetValues<FlightInfo.BatteryCellCount>())
            {
                <MudSelectItem Value="@c">@c</MudSelectItem>
            }
        </MudSelect>

        <MudTextField Label="Тривалість (мм:сс)"
                      @bind-Value="_duration"
                      Placeholder="05:12"
                      Immediate="true" />

        <MudTextField Label="Коментар" @bind-Value="_draft.Comment" />

        <MudDatePicker @bind-Date="_draft.Date" Label="Дата польоту" />

        <MudButton Color="Color.Primary"
                   Disabled="!IsValid"
                   OnClick="Submit">
            <MudIcon Icon="@Icons.Material.Filled.AddCircle" Class="me-1" />
            Додати
        </MudButton>
    </MudStack>
</MudPaper>

@code {
    [Parameter] public EventCallback<FlightInfo> OnAdd { get; set; }

    private FlightInfo _draft = new() { Date = DateTime.Today };
    private string _duration;

    private bool IsValid => !string.IsNullOrWhiteSpace(_draft.Name);

    private async Task Submit()
    {
        if (!IsValid) 
            return;

        _draft.Date ??= DateTime.Today;

        // Додамо унікальний Id, якщо його ще немає
        if (string.IsNullOrEmpty(_draft.Id))
            _draft.Id = Guid.NewGuid().ToString();

        // Піднімаємо подію нагору
        await OnAdd.InvokeAsync(_draft);

        // Очищаємо форму
        _draft = new() { Date = DateTime.Today, BatType = FlightInfo.BatteryType.Unknown };
        _duration = string.Empty;
    }
}
